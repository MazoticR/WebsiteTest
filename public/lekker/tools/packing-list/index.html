<!DOCTYPE html>
<html>
<head>
  <title>ApparelMagic API Packing List</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    #header, #footer {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background-color: #e9ecef;
      position: sticky;
      top: 0;
    }
    tr[data-size="XS"] { background-color: #f0f9ff; }
    tr[data-size="S"] { background-color: #e6f7ff; }
    tr[data-size="M"] { background-color: #fff7e6; }
    tr[data-size="L"] { background-color: #f0fff0; }
    tr[data-size="XL"] { background-color: #fff0f5; }
    tr[data-size="XXL"] { background-color: #f5f0ff; }
    tr[data-size="XXXL"] { background-color: #f0f5ff; }
    input[type="text"] {
      margin: 10px 0;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    .export-buttons {
      margin: 20px 0;
    }
    .export-buttons button {
      background-color: #007bff;
      margin-left: 0;
      margin-right: 10px;
    }
    .export-buttons button.pdf {
      background-color: #dc3545;
    }
    #processing {
      display: none;
      margin: 10px 0;
      color: #0c5460;
      background-color: #d1ecf1;
      padding: 10px;
      border-radius: 4px;
    }
    .error {
      color: #dc3545;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
        /* Estilos nuevos */
    @media print {
      #header {
        margin-bottom: 20px;
      }
      table {
        page-break-after: auto;
      }
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      td {
        padding: 3px !important;
        font-size: 12px;
      }
    }
    /* Final del codigo nuevo */
  </style>
</head>
<body>
  <h1>ApparelMagic API Packing List</h1>
  <div>
    <input type="text" id="shipmentId" placeholder="Ingresa el Shipment ID" />
    <button onclick="fetchShipment()">Generar Packing List</button>
  </div>
  <div id="processing">Cargando informacion del shipment...</div>
  <div id="error" class="error" style="display:none"></div>
  <div class="export-buttons" id="exportButtons" style="display:none">
    <button onclick="exportToPDF()" class="pdf">Exportar a PDF</button>
    <button onclick="exportToExcel()">Exportar a Excel</button>
  </div>
  <div id="results"></div>

  <script>
    // Inicia jsPDF
    const { jsPDF } = window.jspdf;
    let currentShipmentData = null;

    async function fetchShipment() {
      const shipmentId = document.getElementById('shipmentId').value;
      if (!shipmentId) {
        showError("Porfavor ingresa un Shipment ID");
        return;
      }

      document.getElementById('error').style.display = 'none';
      document.getElementById('processing').style.display = 'block';
      document.getElementById('results').innerHTML = '';
      document.getElementById('exportButtons').style.display = 'none';

      try {
        // Toma de datos del shipment.
        const response = await fetch(`/api/shipments?token=6002f37a06cc09759259a7c5eabff471&shipmentId=${shipmentId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        if (!data.response || data.response.length === 0) {
          throw new Error("No se encontro información de algun envio.");
        }
        
        const shipment = data.response[0];
    
    // Tomar todos los POs del cliente en un pick ticket
    let customerPOs = [];
    
    // Manejar diferentes formatos de selected_pick_ticket_ids
    if (shipment.selected_pick_ticket_ids) {
      let pickTicketIds = [];
      
      // Caso 1: Ya es un arreglo
      if (Array.isArray(shipment.selected_pick_ticket_ids)) {
        pickTicketIds = shipment.selected_pick_ticket_ids;
      } 
      // Caso 2: Es un string separado por comas
      else if (typeof shipment.selected_pick_ticket_ids === 'string') {
        pickTicketIds = shipment.selected_pick_ticket_ids.split(',').map(id => id.trim());
      }
      // Caso 3: Es un solo valor.
      else {
        pickTicketIds = [String(shipment.selected_pick_ticket_ids)];
      }
      
      // Filtrar valores vacios
      pickTicketIds = pickTicketIds.filter(id => id && id !== 'null' && id !== 'undefined');
      
      if (pickTicketIds.length > 0) {
        // Pedir todos los pick_tickets en parallelo
        const pickTicketPromises = pickTicketIds.map(pickTicketId => 
          fetch(`/api/pick_tickets?token=6002f37a06cc09759259a7c5eabff471&pickTicketId=${pickTicketId}`)
            .then(res => res.ok ? res.json() : null)
            .catch(() => null)
        );
        
        const pickTicketResponses = await Promise.all(pickTicketPromises);
        
        // Extraer todos los POs unicos
        pickTicketResponses.forEach(response => {
          if (response?.response?.[0]?.customer_po) {
            const po = response.response[0].customer_po.trim();
            if (po && !customerPOs.includes(po)) {
              customerPOs.push(po);
            }
          }
        });
      }
    }
        
    // Añadir el PO del customer a los datos del envio (Separados por comma)
    shipment.customer_po = customerPOs.length > 0 
      ? customerPOs.join(', ') 
      : 'N/A';
        
        processShipmentData(data.response[0]);
      } catch (error) {
        showError(error.message);
      } finally {
        document.getElementById('processing').style.display = 'none';
      }
    }

function processShipmentData(shipment) {
  // Definir el orden por tallas (añadir alguna que llegue a faltar)
  const SIZE_ORDER = ['XXS', 'XS', 'S', 'M', 'L', 'XL', '2XL', 'XXL', '3XL', 'XXXL', '4XL', '5XL'];
  
  // Normalizar las tallas (mapear las variaciones de manera standard)
  const SIZE_ALIASES = {
    '2XL': 'XXL',
    '3XL': 'XXXL',
    '4XL': 'XXXXL'
  };

  const groupedItems = {};
  const sizeTotals = {};
  const styleCount = new Set();
  
  // Primero: agrupar items por estili+tamaño+cantidad
  shipment.boxes.forEach(box => {
    box.box_items.forEach(item => {
      // Normalizar talla
      let normalizedSize = item.size.toUpperCase().trim();
      normalizedSize = SIZE_ALIASES[normalizedSize] || normalizedSize;
      
      const quantity = parseInt(item.qty) || 0;
      const key = `${item.style_number}|${item.description}|${item.attr_2}|${normalizedSize}|${quantity}`;
      
      if (!groupedItems[key]) {
        groupedItems[key] = {
          style: item.style_number,
          description: item.description,
          color: item.attr_2,
          size: normalizedSize,
          originalSize: item.size,
          sizeOrder: SIZE_ORDER.indexOf(normalizedSize),
          qtyPerBox: quantity,
          totalQty: 0,
          boxes: []
        };
        styleCount.add(item.style_number);
      }
      
      groupedItems[key].totalQty += quantity;
      groupedItems[key].boxes.push(box.box_number);
    });
  });

  // Convertir el arreglo y acomodarlo
  const sortedData = Object.values(groupedItems).sort((a, b) => {
    // Primero por estilo
    if (a.style !== b.style) return a.style.localeCompare(b.style);
    
    // Luego por nuestro orden de talla definido
    if (a.sizeOrder !== b.sizeOrder) return a.sizeOrder - b.sizeOrder;
    
    // Luego las cantidades por caja(la mas grandes primero)
    return b.qtyPerBox - a.qtyPerBox;
  });

  // Preparar para mostrar (usando valores originales de las tallas)
  const displayData = sortedData.map(item => {
    const boxNumbers = Array.from(item.boxes).sort((a, b) => a - b);
    const boxRange = boxNumbers.length > 1 
      ? `${boxNumbers[0]}-${boxNumbers[boxNumbers.length - 1]}` 
      : boxNumbers[0];
      
    // Rastrear totales por talla (usando las tallas normalizadas)
    sizeTotals[item.size] = (sizeTotals[item.size] || 0) + item.totalQty;
    
    return {
      'Box Range': boxRange,
      '# Boxes': boxNumbers.length,
      'Qty/Box': item.qtyPerBox, // Nueva columna
      'Style': item.style,
      'Description': item.description,
      'Color': item.color,
      'Size': item.originalSize, // Mostrar valor del tamaño original
      'Total Qty': item.totalQty
    };
  });

  // Guardar para exportar
  currentShipmentData = {
    header: {
      customer: shipment.customer_name,
      address1: shipment.address_1 || '',
      address2: shipment.address_2 || '',
      city: shipment.city || '',
      state: shipment.state || '',
      zip: shipment.postal_code || '',
      country: shipment.country || '',
      shipmentId: shipment.id,
      date: shipment.date,
      customer_po: shipment.customer_po || 'N/A'
    },
    body: displayData,
    footer: {
      totalStyles: styleCount.size,
      totalBoxes: shipment.boxes.length,
      totalQty: displayData.reduce((sum, item) => sum + item['Total Qty'], 0),
      sizeTotals: sizeTotals
    }
  };

  displayResults();
}

    function displayResults() {
      const { header, body, footer } = currentShipmentData;
      
      
    // Armar la direccion con los datos del API
    const addressLines = [
    header.address1,
    header.address2,
    `${header.city}, ${header.state} ${header.zip}`,
    header.country
     ].filter(line => line.trim() !== ''); // Remover lineas vacias
      
      

  // Titulo con direcciones
  const headerHTML = `
    <div id="header">
      <h2>SHIP TO: ${header.customer}</h2>
      <div class="address" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
        ${addressLines.map(line => `<div>${line}</div>`).join('')}
      </div>
      <p>
        <strong>Shipment ID:</strong> ${header.shipmentId} | 
        <strong>Date:</strong> ${header.date} | 
        <strong>Customer PO:</strong> ${header.customer_po || 'N/A'}
      </p>
    </div>
  `;
      
      // Tabla
      let tableHTML = '<table><tr>';
      Object.keys(body[0]).forEach(key => {
        tableHTML += `<th>${key}</th>`;
      });
      tableHTML += '</tr>';
      
      body.forEach(row => {
        tableHTML += `<tr data-size="${row['Size']}">`;
        Object.values(row).forEach(val => {
          tableHTML += `<td>${val}</td>`;
        });
        tableHTML += '</tr>';
      });
      tableHTML += '</table>';
      
      // Pie de pagina
      const footerHTML = `
        <div id="footer">
          <h3>SUMMARY</h3>
          <p><strong>Total Styles:</strong> ${footer.totalStyles} | 
             <strong>Total Boxes:</strong> ${footer.totalBoxes} | 
             <strong>Total Quantity:</strong> ${footer.totalQty}</p>
          <p><strong>Size Breakdown:</strong> 
            ${Object.entries(footer.sizeTotals)
              .map(([size, qty]) => `${size} (${qty})`)
              .join(', ')}
          </p>
        </div>
      `;
      
      document.getElementById('results').innerHTML = headerHTML + tableHTML + footerHTML;
      document.getElementById('exportButtons').style.display = 'block';
    }

function exportToPDF() {
  const { header, body, footer } = currentShipmentData;
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: 'mm',
    format: 'a4'
  });

  // Titulo y Direcciones (izquierda)
  doc.setFontSize(16);
  doc.text(`Packing List - ${header.customer}`, 20, 15, { align: 'left' });
  
  // Lineas de direccion (a la izquierda)
  doc.setFontSize(10);
  const addressLines = [
    header.address1,
    header.address2,
    `${header.city}, ${header.state} ${header.zip}`,
    header.country
  ].filter(line => line.trim() !== '');
  
  let addressY = 25;
  const leftMargin = 20; // Ajustar valor para hacerlo mas a la izq etc
  addressLines.forEach(line => {
    doc.text(line, leftMargin, addressY, { align: 'left' }); // cambiado a 20 en vez de 105
    addressY += 5;
  });

  // Informacion del shipment (centrado)
  doc.text(
    `Shipment ID: ${header.shipmentId} | Date: ${header.date} | Customer PO: ${header.customer_po || 'N/A'}`,
    105,
    addressY + 5,
    { align: 'center' }
  );

  // Calcular el ancho de la tabla y centrar
  const tableWidth = 148;
  const tableMargin = (210 - tableWidth) / 2;

  // Tabla principal del packing list.
  doc.autoTable({
    head: [['Box Range', 'Qty/Box', 'Style', 'Description', 'Color', 'Size', 'Total Qty']],
    body: body.map(row => [
      row['Box Range'],
      row['Qty/Box'],
      row['Style'],
      row['Description'],
      row['Color'],
      row['Size'],
      row['Total Qty']
    ]),
    startY: addressY + 12,
    margin: { left: 31, right: 31 }, // 210mm - 148mm = 62mm → 31mm cada lado
    tableWidth:148,
    styles: {
      fontSize: 9,
      cellPadding: 2,
      valign: 'middle',
      textColor: [0, 0, 0],
      lineColor: [0, 0, 0],
      lineWidth: 0.2
    },
    headerStyles: {
      fillColor: [233, 236, 239],
      textColor: [0, 0, 0],
      fontStyle: 'bold',
      fontSize: 10,
      cellPadding: 3,
      lineWidth: 0.3
    },
    columnStyles: {
      0: { cellWidth: 20 },
      1: { cellWidth: 15 },
      2: { cellWidth: 20 },
      3: { cellWidth: 38 },
      4: { cellWidth: 15 },
      5: { cellWidth: 20 },
      6: { cellWidth: 20 }
    },
    bodyStyles: {
      lineColor: [0, 0, 0],
      lineWidth: 0.2,
      halign: 'center'
    },
    columnStyles: {
      2: { halign: 'left' },
      3: { halign: 'center' }
    }
  });

  // Tabla del breakdown - con centrado, y arreglado de las deformidades.
  const sizeBreakdown = calculateSizeBreakdown(body);
  const summaryStartY = doc.lastAutoTable.finalY + 10;

  doc.setFontSize(12);
  doc.text('Size Breakdown Summary', 105, summaryStartY, { align: 'center' });

  
  //Summary tabla
  doc.autoTable({
    startY: summaryStartY + 5,
    margin: { left: 6.5 }, // Margen izquierdo
    tableWidth: 180, // dejar mas ancho porque tabla mas grande
    head: [[
      { content: 'Style#', styles: { cellWidth: 20 } },
      { content: 'Style Description', styles: { cellWidth: 40 } },
      { content: 'COLOR CODE', styles: { cellWidth: 20 } },
      { content: 'XS', styles: { cellWidth: 12 } },
      { content: 'S', styles: { cellWidth: 12 } },
      { content: 'M', styles: { cellWidth: 12 } },
      { content: 'L', styles: { cellWidth: 12 } },
      { content: 'XL', styles: { cellWidth: 12 } },
      { content: '2XL', styles: { cellWidth: 12 } }, // Cabezal de 1 linea
      { content: '3XL', styles: { cellWidth: 12 } },
      { content: '4XL', styles: { cellWidth: 12 } },
      { content: 'TOTAL UNITS', styles: { cellWidth: 20 } }
    ]],
    body: sizeBreakdown.rows,
    styles: {
      fontSize: 8,
      cellPadding: 1.5,
      valign: 'middle',
      halign: 'center',
      lineColor: [0, 0, 0],
      lineWidth: 0.2,
      minCellHeight: 5 // Prevee que el texto no se deforme dentro de la celda
    },
    headerStyles: {
      fillColor: [233, 236, 239],
      textColor: [0, 0, 0],
      fontStyle: 'bold',
      fontSize: 9,
      lineWidth: 0.3,
      cellPadding: 2,
      
      //Para remarcar la tabla
    
      lineColor: [0, 0, 0],  // Linea para las cabezas de las columnas
      lineWidth: 0.3
      
    },
    bodyStyles: {
    lineColor: [0, 0, 0],  // Para los bordes de la tabla.
    lineWidth: 0.2         // 
    },
columnStyles: {
  0: { cellWidth: 20 },  // Style#
  1: { cellWidth: 35 },  // Description
  2: { cellWidth: 20 },  // Color
  // Tamaño de las columnas - todas con un ancho determinado
  3: { cellWidth: 10, overflow: 'hidden' },  // XS
  4: { cellWidth: 10, overflow: 'hidden' },  // S
  5: { cellWidth: 10, overflow: 'hidden' },  // M
  6: { cellWidth: 10, overflow: 'hidden' },  // L
  7: { cellWidth: 10, overflow: 'hidden' },  // XL
  8: { cellWidth: 10, overflow: 'hidden' },  // 2XL (una sola linea)
  9: { cellWidth: 10, overflow: 'hidden' },  // 3XL
  10: { cellWidth: 10, overflow: 'hidden' }, // 4XL
  11: { cellWidth: 15 }  // TOTAL
},
styles: {
  // Para evitar que las filas esten grandes
  minCellHeight: 5,
  fontSize: 8
}
  });

  // Pie de pagina con totales
  doc.setFontSize(10);
  doc.text(
    `Total Styles: ${footer.totalStyles} | Total Boxes: ${footer.totalBoxes} | Total Quantity: ${footer.totalQty}`,
    105,
    doc.internal.pageSize.height - 10,
    { align: 'center' }
  );
  
  
  // Final del exportPDF
  const finalY = doc.lastAutoTable.finalY + 15; // Espacio despues de la tabla
  
  // Añadir fecha actual (formateado como MM/DD/YYYY)
  const today = new Date();
  const formattedDate = `${today.getMonth()+1}/${today.getDate()}/${today.getFullYear()}`;
  
  // Firma / fecha de recibido / Fecha del packing
  doc.setFontSize(10);
  doc.text('Received by: __________________________', 20, finalY+10);
  doc.text('Received date: __________________________', 20, finalY+20);
  doc.text(`Packing List Date: ${formattedDate}`, 140, finalY);

  // Linea horizontal despues de la tabla
  doc.setDrawColor(0, 0, 0);
  doc.setLineWidth(0.3);
  doc.line(20, finalY - 5, 190, finalY - 5);
  
  doc.save(`PackingList_${header.shipmentId}.pdf`);
}
  
    // Funcion para calcular el size breakdown
function calculateSizeBreakdown(body) {
  const sizeMap = {
    'XS': 0, 'S': 0, 'M': 0, 'L': 0, 
    'XL': 0, '2XL': 0, '3XL': 0, '4XL': 0
  };
  
  const styles = {};
  let grandTotal = 0;

  body.forEach(row => {
    const size = row.Size.toUpperCase();
    const qty = parseInt(row['Total Qty']) || 0;
    
    if (!styles[row.Style]) {
      styles[row.Style] = {
        description: row.Description,
        color: row.Color,
        sizes: JSON.parse(JSON.stringify(sizeMap)),
        total: 0
      };
    }
    
    if (styles[row.Style].sizes.hasOwnProperty(size)) {
      styles[row.Style].sizes[size] += qty;
      styles[row.Style].total += qty;
      sizeMap[size] += qty;
      grandTotal += qty;
    }
  });

  // Preparar filas de la tabla
  const rows = Object.keys(styles).map(style => [
    style,
    styles[style].description,
    styles[style].color,
    styles[style].sizes.XS,
    styles[style].sizes.S,
    styles[style].sizes.M,
    styles[style].sizes.L,
    styles[style].sizes.XL,
    styles[style].sizes['2XL'],
    styles[style].sizes['3XL'],
    styles[style].sizes['4XL'],
    styles[style].total
  ]);

  // Añadir el total de las tablas
  rows.push([
    'TOTAL',
    '',
    '',
    sizeMap.XS,
    sizeMap.S,
    sizeMap.M,
    sizeMap.L,
    sizeMap.XL,
    sizeMap['2XL'],
    sizeMap['3XL'],
    sizeMap['4XL'],
    grandTotal
  ]);

  return {
    rows: rows,
    totalStyles: Object.keys(styles).length,
    grandTotal: grandTotal
  };
}
    
    

    function exportToExcel() {
      const { header, body } = currentShipmentData;
      const headers = Object.keys(body[0]);
      const csvRows = [
        headers.join(','),
        ...body.map(row => 
          headers.map(field => 
            `"${String(row[field] || '').replace(/"/g, '""')}"`
          ).join(',')
        )
      ];
      
      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `PackingList_${header.shipmentId}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }
  </script>
</body>
</html>